{% extends "base.html" %}
{% block title %}Port Forward - Phreakwall{% endblock %}
{% block content %}
<div class="card">
    <h2>➡️ Port Forwarding Configuration</h2>
    <p style="color: #9ca3af; margin-bottom: 2rem;">Configure port forwarding rules (DNAT)</p>

    <div style="margin-bottom: 2rem;">
        <h3>Add Port Forward</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="pf_protocol" placeholder="Protocol (tcp/udp)">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="pf_external_port" placeholder="External Port">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="pf_internal_ip" placeholder="Internal IP">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="pf_internal_port" placeholder="Internal Port">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="pf_interface" placeholder="Interface">
            </div>
            <button class="btn" onclick="addPortForward()">➕ Add Forward</button>
        </div>
    </div>

    <h3>Port Forwarding Rules</h3>
    <table>
        <thead>
            <tr>
                <th>Protocol</th>
                <th>External Port</th>
                <th>Internal IP</th>
                <th>Internal Port</th>
                <th>Interface</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="pf-tbody">
            <tr>
                <td colspan="7" style="padding: 2rem; text-align: center; color: #9ca3af;">No port forwarding rules configured</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Common Services</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <button class="btn btn-secondary" onclick="quickAdd('tcp', '80', 'HTTP')">HTTP (80)</button>
        <button class="btn btn-secondary" onclick="quickAdd('tcp', '443', 'HTTPS')">HTTPS (443)</button>
        <button class="btn btn-secondary" onclick="quickAdd('tcp', '22', 'SSH')">SSH (22)</button>
        <button class="btn btn-secondary" onclick="quickAdd('tcp', '3389', 'RDP')">RDP (3389)</button>
        <button class="btn btn-secondary" onclick="quickAdd('tcp', '3306', 'MySQL')">MySQL (3306)</button>
        <button class="btn btn-secondary" onclick="quickAdd('tcp', '5432', 'PostgreSQL')">PostgreSQL (5432)</button>
    </div>
</div>

<div id="result"></div>

<script>
function addPortForward() {
    const protocol = document.getElementById('pf_protocol').value;
    const external_port = document.getElementById('pf_external_port').value;
    const internal_ip = document.getElementById('pf_internal_ip').value;
    const internal_port = document.getElementById('pf_internal_port').value;
    const iface = document.getElementById('pf_interface').value;

    if (!protocol || !external_port || !internal_ip || !internal_port || !iface) {
        document.getElementById('result').innerHTML = '<div class="alert alert-error">Please fill all fields</div>';
        return;
    }

    fetch('/api/portforward', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({protocol, external_port, internal_ip, internal_port, interface: iface})
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('result').innerHTML = data.status === 'success'
            ? '<div class="alert alert-success">✓ ' + data.message + '</div>'
            : '<div class="alert alert-error">✗ ' + data.message + '</div>';
        if (data.status === 'success') {
            document.getElementById('pf_protocol').value = '';
            document.getElementById('pf_external_port').value = '';
            document.getElementById('pf_internal_ip').value = '';
            document.getElementById('pf_internal_port').value = '';
            document.getElementById('pf_interface').value = '';
            loadPortForwards();
        }
    });
}

function quickAdd(protocol, port, name) {
    document.getElementById('pf_protocol').value = protocol;
    document.getElementById('pf_external_port').value = port;
    document.getElementById('pf_internal_port').value = port;
    document.getElementById('result').innerHTML = '<div class="alert" style="background: #3d4465;">Fill in Internal IP and Interface for ' + name + '</div>';
}

function loadPortForwards() {
    fetch('/api/portforward')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('pf-tbody');
            if (data.forwards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; text-align: center; color: #888;">No port forwarding rules configured</td></tr>';
            }
        });
}

loadPortForwards();
</script>
{% endblock %}
